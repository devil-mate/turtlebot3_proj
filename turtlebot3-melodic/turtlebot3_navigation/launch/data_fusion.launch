<launch>
   
   <!-- <arg name="imuFilter_in_mag" default="imu_raw" /> --> 
   <!-- <arg name="imuFilter_in_data" default="mavros/imu/mag" /> -->


   <arg name="prefix" default="robot_"/>
   <arg name="launch_pose_ekf" default="false"/>
   <arg name="localization_ekf_pose" default="true"/> 
   <arg name="localization_gps_pose" default="false"/> <!--gps（-odom） localization -->
   <arg name="imuodom_pub_tf" default="true"/>
   <!-- <arg name="odom_filter_topic" default="odom_topic"/> -->
   



   <!-- laser -->
   <arg name="laser_raw_topic" default="front_laser/scan"/> 
   <arg name="laser_filtered_topic" default="laser_filter"/>
   <arg name="laser_box_frame" default="robot_front_laser_link"/>
   <!-- imu params -->
   <arg name="imu_raw_data" default="imu/data_raw" />
   <arg name="imu_raw_mag" default="mavros/imu/mag" />
   <arg name="imuFilter_fixed_frame" default="robot_imu_link" />
   <!-- odom（&imu） params -->
   <arg name="odom_raw_topic" default="odom" />
   <arg name="vins_out_odom" default="vins/odometry"/>
   <!-- <arg name="odom_raw_topic" default="robotnik_base_control/odom" /> -->
   <arg name="imuodom_topic_imu_in" default="imu/data"/>
   <arg name="imuodom_topic_pub" default="/imuodom_pub"/>

   <!-- gps odom params-->
   <arg name="gps_raw" default="gps/NavSatFix"/>
   <arg name="gpsodom_topic_imu_in" default="$(arg imuodom_topic_imu_in)"/>
   <arg name="gpsodom_topic_odom_in" default="$(arg imuodom_topic_pub)"/>
   <arg name="gpsodom_topic_pub" default="odometry/filtered_gpsodom"/>
   <!-- frame name -->
   <arg name="map_frame" default="map"/>
   <arg name="odom_frame" default="odom"/>
   <arg name="base_frame" default="base_link"/>
   <arg name="world_frame" default="world_frame"/> 

   <!-- <arg name="odom_frame" default="$(arg prefix)odom"/> 
   
   <arg name="base_frame" default="$(arg prefix)base_footprint"/> -->

   

    <!-- laser filter -->
   <node pkg="laser_filters" type="scan_to_scan_filter_chain" name="laser_filter">
      <rosparam command="load" file="$(find tv_slam)/config/laserfilter_params.yaml" subst_value="true"/>
      <remap from="scan" to="$(arg laser_raw_topic)" />
      <remap from="scan_filtered" to="$(arg laser_filtered_topic)" />
   </node>

  <!-- imu 融合/滤波 -->
   <node pkg="imu_complementary_filter" type="complementary_filter_node" name="complementary_filter_node" output="screen">
      <remap from="imu/mag" to="$(arg imu_raw_mag)"/>
      <remap from="imu/data_raw" to="$(arg imu_raw_data)"/>
      <!-- <remap from="imu/data" to="/imu_data"/> -->
      <param name="fixed_frame" value="$(arg imuFilter_fixed_frame)"/>

      <param name="gain_acc" value="0.01"/>
      <param name="gain_mag" value="0.01"/>
      <param name="bias_alpha" value="0.01"/>
      <param name="do_bias_estimation" value="true"/>
      <param name="do_adaptive_gain" value="true"/>
      <param name="use_mag" value="false"/>
      <param name="publish_tf" value="false"/>
      <param name="reverse_tf" value="false"/>
      <param name="constant_dt" value="0.0"/>

      <param name="publish_debug_topics" value="true"/>
   </node>


   <!-- 1. imu_data & odom -->
   <!--发布 odom-baselink tf  -->
    <node if="$(arg launch_pose_ekf)" pkg="robot_pose_ekf" type="robot_pose_ekf" name="robot_pose_ekf"> 
        <rosparam file="$(find tv_navigation)/config_tv/pose_ekf_params.yaml" command="load" subst_value="true"/>
        <remap from="imu_data" to="$(arg imuodom_topic_imu_in)"/>
        <remap from="odom" to="$(arg odom_raw_topic)" />
        <!-- pub: robot_pose_ekf/odom_combined  TF-->
    </node> 

    <!-- 2. imu_data & odom  -->
      <!-- ekf_loc1 fuses only continuous data (imu and odometry). Publish the tf from odom_frame to base_footprint -->
    <node if="$(arg localization_ekf_pose)" pkg="robot_localization" type="ekf_localization_node" name="ekf_imu_odom" clear_params="true" output="screen" >      
      <!-- sub imu/data-->
      <param name="odom0" value="$(arg odom_raw_topic)"/> <!-- previously: /odom -->
      <param name="imu0" value="$(arg imuodom_topic_imu_in)"/>        <!-- previously: /imu/data --> 

      <!-- pub  -->
      <remap from="odometry/filtered" to="$(arg imuodom_topic_pub)" />
      <rosparam file="$(find tv_navigation)/config_tv/ekf_imu_odom_params.yaml" command="load" subst_value="true"/>

      <!-- <param name="odom_frame" value="$(arg odom_frame)"/>
      <param name="base_link_frame" value="$(arg base_frame)"/>
      <param name="world_frame" value="$(arg odom_frame)"/>

      <param name="frequency" value="45"/>
      <param name="sensor_timeout" value="0.1"/>
      <param name="two_d_mode" type="bool" value="true"/>
      <param name="publish_tf" value="$(arg imuodom_pub_tf)"/>
      
   
      <rosparam param="odom0_config">[true, true, false,
                                       false, false, false,
                                       false, false, false,
                                       false, false, false,
                                       false, false, false]</rosparam>
      <rosparam param="imu0_config">[false, false, false,
                                     false, false, false, 
                                     false, false, false,
                                     false, false, true,
                                     true, false, false]</rosparam>
      <param name="odom0_relative" value="false"/>
      <param name="odom0_differential" value="true"/>
      <param name="imu0_relative" value="false"/>
      <param name="imu0_differential" value="false" />
      <param name="imu0_remove_gravitational_acceleration" type="bool" value="true"/>
      <param name="print_diagnostics" value="false"/> -->
  </node>
  <!-- TODO if merge gps , 三个一起融合; 保留串级融合用于精度比较 -->
  
   <!-- GPS -->
   <include if="$(arg localization_gps_pose)" file="$(find tv_navigation)/launch/tv_robot_localization.launch">
      <arg name="gpsodom_topic_imu_in"  value="$(arg gpsodom_topic_imu_in)"/> 
      <arg name="gpsodom_topic_odom_in"  value="$(arg gpsodom_topic_odom_in)"/> 
      <arg name="gps_raw"  value="$(arg gps_raw)"/>
      <arg name="gpsodom_topic_pub"  value="$(arg gpsodom_topic_pub)"/> 

      <arg name="odom_frame"  value="$(arg odom_frame)"/> 
      <arg name="world_frame"  value="$(arg odom_frame)"/> 
      <arg name="base_frame"  value="$(arg base_frame)"/>
    </include>


  
</launch>
